<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iffy.app</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
  <style>
    /* Custom Animations */
    @keyframes chase {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes spin {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .political-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      animation: chase 2s linear infinite;
    }

    .elephant, .donkey {
      width: 50px;
      height: 50px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      animation: spin 1s ease-in-out infinite;
    }

    .elephant {
      background-image: url('red-elephant-icon.png'); /* Replace with your image URL */
    }

    .donkey {
      background-image: url('blue-donkey-icon.png'); /* Replace with your image URL */
    }
    .fade-in {
      opacity: 0;
      transition: opacity 0.5s;
    }
    .fade-in.visible {
      opacity: 1;
    }
    .citation {
      color: #1a73e8;
      cursor: pointer;
    }
    .bias-link {
      margin-left: 10px;
    }
  html, body {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  /* Content takes all available space except the footer */
  .content {
    flex: 1;
  }

  /* Footer always sticks to the bottom */
  footer {
    background-color: #1a202c;
    color: white;
    text-align: center;
    padding: 1rem 0;
  }

  footer a {
    color: #63b3ed;
    text-decoration: underline;
  }

  footer a:hover {
    color: #3182ce;
  }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-r from-red-500 via-white to-blue-500 bg-opacity-80">
  <div class="content">
  <div class="max-w-4xl mx-auto mt-10 p-8 bg-white rounded-lg shadow-lg">
    <div class="text-center mb-6">
      <img src="/favicon.png" alt="iffy.app favicon" class="inline-block w-60 h-60">
    </div>
    <h1 class="text-3xl font-bold text-gray-800 mb-8">How Much Should You Care About This Issue?</h1>
    <p class="text-gray-700 mb-4 mt-4">
      Enter a US political topic and describe how it affects you personally, if at all. This tool will assess its broader relevance and recommend how much time you should dedicate to learning about or discussing it.
    </p>

<div>
  <label for="bias-preference" class="block text-gray-700 font-medium mb-2">
    Political Preference
    <span class="relative group">
      <span class="text-sm text-gray-500 cursor-pointer">[?]</span>
      <span class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded-lg px-2 py-1 w-64 -top-10 left-1/2 transform -translate-x-1/2 shadow-lg">
        Choose between Center, Left, or Right to tailor the assessment to your political preferences. This will analyze the topic through the preferred political lens, and the tool will prefer sources aligned with the selection.
      </span>
    </span>
  </label>
  <select
    id="bias-preference"
    name="bias-preference"
    class="mt-2 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-md bg-gradient-to-r from-gray-100 to-gray-50 focus:ring-blue-500 focus:border-blue-500 hover:shadow-lg transition duration-200 ease-in-out sm:text-sm"
  >
    <option value="neutral">Center</option>
    <option value="left">Left</option>
    <option value="right">Right</option>
  </select>
</div>

<div>
  <label for="year" class="block text-gray-700 font-medium mb-2 mt-1">
    Year
    <span class="relative group">
      <span class="text-sm text-gray-500 cursor-pointer">[?]</span>
      <span class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded-lg px-2 py-1 w-64 -top-10 left-1/2 transform -translate-x-1/2 shadow-lg">
        Choose a year to prefer sources and analysis from that time period.
      </span>
    </span>
  </label>
  <select
    id="year"
    name="year"
    class="mt-2 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-md bg-gradient-to-r from-gray-100 to-gray-50 focus:ring-blue-500 focus:border-blue-500 hover:shadow-lg transition duration-200 ease-in-out sm:text-sm"
  >
    <script>
      const params = new URLSearchParams(window.location.search);
      const currentYear = new Date().getFullYear();
      const y = parseInt(params.get('year') || currentYear.toString());
      for (let year = currentYear; year >= 1970; year--) {
        document.write(`<option value="${year}">${year}</option>`);
      }
    </script>
  </select>
</div>

<div>
  <label for="days-per-year" class="block text-gray-700 font-medium mb-2 mt-2">
    Number of Days per Year
    <span class="relative group">
      <span class="text-sm text-gray-500 cursor-pointer">[?]</span>
      <span class="absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded-lg px-2 py-1 w-64 -top-10 left-1/2 transform -translate-x-1/2 shadow-lg">
        Specify the number of days you're willing to spend per year researching, considering, and discussing political topics.
      </span>
    </span>
  </label>
  <select
    id="days-per-year"
    name="days-per-year"
    class="mt-2 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-md bg-gradient-to-r from-gray-100 to-gray-50 focus:ring-blue-500 focus:border-blue-500 hover:shadow-lg transition duration-200 ease-in-out sm:text-sm"
  >
    <script>
      const daysPerYear = parseInt(params.get('daysPerYear') || '10');
      for (let days = 1; days <= 90; days++) {
        const selected = days === daysPerYear ? 'selected' : '';
        document.write(`<option value="${days}" ${selected}>${days} (${days * 24} hours)</option>`);
      }
      for (let days = 120; days <= 240; days += 30) {
        const selected = days === daysPerYear ? 'selected' : '';
        document.write(`<option value="${days}" ${selected}>${days} (${days * 24} hours)</option>`);
      }
    </script>
  </select>
</div>


    <form id="topic-form" class="space-y-6">
      <div>
        <label for="topic" class="block text-gray-700 font-medium mt-2 ">Whatâ€™s the Issue?</label>
        <input 
          type="text" 
          id="topic" 
          name="topic" 
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          placeholder="e.g., Healthcare policy"
          required
        />
      </div>

      <div>
        <label for="personal-impact" class="block text-gray-700 font-medium">
          How Does This Affect You? (Optional)
        </label>
        <textarea
          id="personal-impact"
          name="personal-impact"
          rows="4"
          class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          placeholder="Provide a specific example, such as: 'I have perfect healthcare and will never have to pay more than a $10 co-pay.'"
        ></textarea>
      </div>

      <button 
        type="submit" 
        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        See Your Recommendation
      </button>
    </form>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="political-spinner hidden mt-14 mb-4">
      <div class="elephant"></div>
      <div class="donkey"></div>
    </div>

    <div id="result" class="mt-8 hidden">
      <h2 class="text-2xl font-semibold text-gray-800">Results</h2>
      <div id="weights" class="mt-6 space-y-6"></div>
      <p class="mt-6 text-lg font-semibold text-gray-800" id="final-time"></p>
      <p class="mt-4 pl-8 bg-gray-100 border-l-4 border-blue-500 text-gray-700 p-4 rounded" id="final-time-description"></p>
      <h3 class="text-xl font-semibold text-gray-800 mt-8">Sources</h3>
      <ul id="sources" class="list-disc list-inside text-gray-700 mt-2"></ul>
      <div id="disclaimer" class="mt-4 pl-8 bg-gray-100 border-l-4 border-blue-500 text-gray-700 p-4 rounded mb-2"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);

  const topic = params.get('topic');
  const personalImpact = params.get('personalImpact');
  const biasPreference = params.get('biasPreference');
  const year = params.get('year');

  if (topic) document.getElementById('topic').value = topic;
  if (personalImpact) document.getElementById('personal-impact').value = personalImpact;
  if (biasPreference) document.getElementById('bias-preference').value = biasPreference;
  if (year) document.getElementById('year').value = year;

  // Trigger the analysis if query params are present
  if (topic) {
    document.getElementById('topic-form').dispatchEvent(new Event('submit'));
  }
});

  document.getElementById('topic-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const topic = document.getElementById('topic').value.trim();
    const personalImpact = document.getElementById('personal-impact').value.trim();
    const biasPreference = document.getElementById('bias-preference').value;
    const year = document.getElementById('year').value;
    const daysPerYear = document.getElementById('days-per-year').value;
    const spinner = document.getElementById('loading-spinner');
    const resultDiv = document.getElementById('result');
    const weightsDiv = document.getElementById('weights');
    const sourcesList = document.getElementById('sources');
    const finalTime = document.getElementById('final-time');
    const finalTimeDescription = document.getElementById('final-time-description');

  // Update query params in the address bar
  const queryParams = new URLSearchParams({
    topic,
    personalImpact,
    biasPreference,
    year,
    daysPerYear,
  }).toString();

  window.history.pushState({}, '', `?${queryParams}`);

    spinner.classList.remove('hidden');
    resultDiv.classList.add('hidden');
    weightsDiv.innerHTML = '';
    sourcesList.innerHTML = '';
    finalTime.textContent = '';

    try {
      const response = await fetch('/calculate-weight', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ topic, personalImpact, biasPreference, year, daysPerYear }),
      });

      const data = await response.json();

      if (data.weights && data.weights.length > 0) {
        data.weights.forEach(({ category, reasoning, weight, sources, facts }) => {
          const container = document.createElement('div');
          container.className = 'p-4 bg-gray-100 rounded-md shadow-sm mb-4';

          const title = document.createElement('h3');
          title.textContent = `${category}: ${weight}/10`;
          title.className = 'text-lg font-medium text-gray-800 mb-2';

          const descriptionPara = document.createElement('p');
          descriptionPara.textContent = reasoning;
          descriptionPara.className = 'text-gray-700 mb-2';

          const toggleReasoning = document.createElement('button');
          toggleReasoning.textContent = 'Show Reasoning';
          toggleReasoning.className = 'text-blue-600 underline cursor-pointer';
          toggleReasoning.addEventListener('click', () => {
            reasoningDiv.classList.toggle('hidden');
            toggleReasoning.textContent = reasoningDiv.classList.contains('hidden')
              ? 'Show Reasoning'
              : 'Hide Reasoning';
          });

          const reasoningDiv = document.createElement('div');
          reasoningDiv.className = 'hidden mt-4';

          const factsList = document.createElement('ul');
          factsList.className = 'list-disc list-inside text-gray-700';
          facts.forEach((fact, index) => {
            const factItem = document.createElement('li');
            const citation = sources[index]?.citation.replace(/[\[\]]/g, "") || '';

            if (citation) {
              factItem.innerHTML = `${fact} <a href="#source-${citation}" target="_blank" class="citation">[${citation}]</a>`;
            } else {
              factItem.textContent = fact;
            }

            factsList.appendChild(factItem);
          });

          reasoningDiv.appendChild(factsList);

          container.appendChild(title);
          container.appendChild(descriptionPara);
          if (facts.length > 0) {
            container.appendChild(toggleReasoning);
          }
          container.appendChild(reasoningDiv);
          weightsDiv.appendChild(container);
        });

        const sourceDisclaimerDiv = document.getElementById('disclaimer');
          sourceDisclaimerDiv.innerHTML = `Seeing broken links? This is an inherent issue with the way sources are currently calculated, which is entirely by AI. While this is difficult conceptually to understand, broken source links do not necessarily imply that the analysis is flawed, since the analysis itself is based on tokenized & aggregated data that OpenAI has fine tuned the model on. LLMs struggle with properly attributing sources for fine-tuned datasets, as in fact the tokenized output of fine tuning is entirely decoupled from the source material the tokens were generated from.<br /><br />If this feels like jargon, think of it this way: LLMs are like if Uncle Ronnie could read the entire Internet. He would retain various snippets of information and broad associations between different topics, but he's probably going to get it wrong sometimes. He certainly can't recite the full link to every article associated with every bit of information he's absorbed (he can for some of them though!), but he's read enough that there are glimmers of interesting information that you pick up on while he's talking (and talking...) at dinner. Maybe you ask for a source for some bold claim and the pointer he gives you is spot on, or maybe it's way off, but either way you have enough information to go find out.<br /><br />This tool is basically that, if you also had the superpower to perform real-time comprehensive analysis of Uncle Ronnie's 2-hour word salad.<br /><br />(there are other, better approaches to this so expect this situation to improve over time)`;
        sourcesList.appendChild(sourceDisclaimerDiv);        

        data.sources.forEach(({ source, ground_news_link, citation }, index) => {
          const sourceItem = document.createElement('li');
          sourceItem.id = `source-${index + 1}`;
          sourceItem.innerHTML = `<a href="${source}" target="_blank" class="text-blue-600 underline">${citation} ${source}</a>`;

          const biasDiv = document.createElement('div');
          biasDiv.className = 'hidden mt-4 pl-8 bg-gray-100 border-l-4 border-blue-500 text-gray-700 p-4 rounded';

          const toggleBias = document.createElement('button');
          toggleBias.textContent = 'Show Bias';
          toggleBias.className = 'text-blue-600 underline cursor-pointer bias-link';

          toggleBias.addEventListener('click', () => {
            if (biasDiv.innerHTML === '') {
              if (ground_news_link) {
                const iframe = document.createElement('iframe');
                iframe.src = `https://snip.info/api/v1/snippet?url=${encodeURIComponent(ground_news_link)}&selector=%23__next%20%3E%20main%20%3E%20div.relative.transition-all.duration-500.z-10%20%3E%20div.bg-light-primary.dark%5C%3Abg-dark-primary.text-dark-primary.dark%5C%3Atext-light-primary%20%3E%20article%20%3E%20div.flex.flex-col.gap-2.tablet%5C%3Agap-3_2.col-span-12.desktop%5C%3Acol-span-9%20%3E%20div%3Anth-child(1)%20%3E%20div%3Anth-child(2)%20%3E%20div%20%3E%20div%3Anth-child(2)&selector=style`;
                iframe.src = `https://snip.info/api/v1/snippet?url=${encodeURIComponent(ground_news_link)}&selector=%23__next%20%3E%20main%20%3E%20div.relative.transition-all.duration-500.z-10%20%3E%20div.bg-light-primary.dark%5C%3Abg-dark-primary.text-dark-primary.dark%5C%3Atext-light-primary%20%3E%20article%20%3E%20div.flex.flex-col.gap-2.tablet%5C%3Agap-3_2.col-span-12.desktop%5C%3Acol-span-9%20%3E%20div%3Anth-child(1)%20%3E%20div%3Anth-child(2)%20%3E%20div%20%3E%20div%3Anth-child(2)&selector=style`
                iframe.className = 'w-full h-64';
                iframe.style.border = 'none';
                biasDiv.appendChild(iframe);
                const sourceP = document.createElement('p');
                sourceP.innerHTML = `<sub><a href='${ground_news_link}'>source</a></sub>`
              } else {
                  biasDiv.innerHTML = `Could not calculate bias for this source. Try searching for <code>${source}</code> on <a class="text-blue-500 underline" href="https://ground.news">Ground News</a>.`;
              }
            }
            biasDiv.classList.toggle('hidden');
            toggleBias.textContent = biasDiv.classList.contains('hidden')
              ? 'Show Bias'
              : 'Hide Bias';
          });

          const biasLink = document.createElement('sup');
          biasLink.appendChild(toggleBias);
          sourceItem.appendChild(biasLink);
          sourceItem.appendChild(biasDiv);
          sourcesList.appendChild(sourceItem);
        });

        finalTime.textContent = `Based on this analysis, you should dedicate approximately ${data.totalHours} hours this year to understanding or discussing this issue because of its relevance and importance.`;
        finalTimeDescription.textContent = data.totalHoursDescription;
        const biasDiv = document.createElement('div');
        resultDiv.classList.remove('hidden');
      } else {
        throw new Error('Invalid response format or no data received.');
      }
    } catch (error) {
      console.error('Error calculating weight:', error);
      finalTime.textContent = 'An error occurred while processing your request.';
      resultDiv.classList.remove('hidden');
    } finally {
      spinner.classList.add('hidden');
    }
  });
</script>
</div>
<!-- Footer -->
<footer class="mt-10 bg-gray-800 text-white py-6">
  <div class="max-w-4xl mx-auto text-center">
    <p class="text-sm">Â© 2024 iffy.app</p>
    <div class="flex justify-center mt-4 space-x-4">
      <!-- Methodology Link -->
      <button 
        id="methodology-button" 
        class="text-blue-400 underline hover:text-blue-500 focus:outline-none"
        onclick="showMethodologyModal()">
        methodology
      </button>

      <!-- Source Link -->
      <a 
        href="https://github.com/zachwalton/iffy.app" 
        target="_blank" 
        class="text-blue-400 underline hover:text-blue-500">
        source
      </a>

      <!-- Contact Link -->
      <a 
        href="mailto:me@zach.us" 
        class="text-blue-400 underline hover:text-blue-500">
        contact
      </a>
    </div>
  </div>
</footer>

<!-- Modal for Methodology -->
<div 
  id="methodology-modal" 
  class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-7xl max-h-[calc(100%-5rem)] overflow-auto mx-20">
    <h2 class="text-lg font-bold mb-4">Methodology</h2>
    <div id="methodology-content" class="text-gray-700 markdown-body">
      <!-- Content will be loaded dynamically here -->
    </div>
    <button 
      class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
      onclick="closeMethodologyModal()">
      Close
    </button>
  </div>
</div>

<script>
  function showMethodologyModal() {
    const modal = document.getElementById('methodology-modal');
    const contentDiv = document.getElementById('methodology-content');

    // Show the modal
    modal.classList.remove('hidden');

    // Load the Markdown content
    fetch('/METHODOLOGY.md')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch methodology content');
        }
        return response.text();
      })
      .then(markdown => {
        const m = new marked.Marked();
        contentDiv.innerHTML = m.parse(markdown);
      })
      .catch(error => {
        contentDiv.innerHTML = '<p class="text-red-600">Failed to load methodology content. Please try again later.</p>';
        console.error(error);
      });
  }

  function closeMethodologyModal() {
    const modal = document.getElementById('methodology-modal');
    modal.classList.add('hidden');
  }

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeMethodologyModal();
    }
  });
</script>
</body>
</html>
